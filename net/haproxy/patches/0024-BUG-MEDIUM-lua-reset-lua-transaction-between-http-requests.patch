commit 5e772266a3682b723ee7522e74e4ef9eacec6218
Author: Patrick Hemmer <haproxy@stormcloud9.net>
Date:   Wed Aug 22 10:02:00 2018 -0400

    BUG/MEDIUM: lua: reset lua transaction between http requests
    
    Previously LUA code would maintain the transaction state between http
    requests, resulting in things like txn:get_priv() retrieving data from
    a previous request. This addresses the issue by ensuring the LUA state
    is reset between requests.
    
    Co-authored-by: Tim DÃ¼sterhus <tim@bastelstu.be>
    
    (cherry picked from commit e3faf02581b36c1c2d58d147bf053ff1257cc319)
    Signed-off-by: Willy Tarreau <w@1wt.eu>

diff --git a/reg-tests/lua/h00001.lua b/reg-tests/lua/h00001.lua
new file mode 100644
index 00000000..999ea887
--- /dev/null
+++ b/reg-tests/lua/h00001.lua
@@ -0,0 +1,15 @@
+core.register_action("bug", { "http-res" }, function(txn)
+	data = txn:get_priv()
+	if not data then
+		data = 0
+	end
+	data = data + 1
+	print(string.format("set to %d", data))
+	txn.http:res_set_status(200 + data)
+	txn:set_priv(data)
+end)
+
+core.register_service("fakeserv", "http", function(applet)
+	applet:set_status(200)
+	applet:start_response()
+end)
diff --git a/reg-tests/lua/h00001.vtc b/reg-tests/lua/h00001.vtc
new file mode 100644
index 00000000..6d38ecab
--- /dev/null
+++ b/reg-tests/lua/h00001.vtc
@@ -0,0 +1,31 @@
+varnishtest "Lua: txn:get_priv() scope"
+feature ignore_unknown_macro
+
+haproxy h1 -conf {
+    global
+        lua-load ${testdir}/h00001.lua
+
+    frontend fe1
+        mode http
+        bind "fd@${fe1}"
+        default_backend b1
+
+        http-response lua.bug
+
+    backend b1
+        mode http
+        http-request use-service lua.fakeserv
+} -start
+
+client c0 -connect ${h1_fe1_sock} {
+    txreq -url "/"
+    rxresp
+    expect resp.status == 201
+    txreq -url "/"
+    rxresp
+    expect resp.status == 201
+}
+
+client c0 -start
+
+client c0 -wait
diff --git a/src/proto_http.c b/src/proto_http.c
index 8ed5f7c1..ecf0683a 100644
--- a/src/proto_http.c
+++ b/src/proto_http.c
@@ -61,6 +61,7 @@
 #include <proto/h1.h>
 #include <proto/log.h>
 #include <proto/hdr_idx.h>
+#include <proto/hlua.h>
 #include <proto/pattern.h>
 #include <proto/proto_tcp.h>
 #include <proto/proto_http.h>
@@ -4371,6 +4372,9 @@ void http_end_txn_clean_session(struct stream *s)
 	s->flags &= ~(SF_CURR_SESS|SF_REDIRECTABLE|SF_SRV_REUSED);
 	s->flags &= ~(SF_ERR_MASK|SF_FINST_MASK|SF_REDISP);
 
+	hlua_ctx_destroy(s->hlua);
+	s->hlua = NULL;
+
 	s->txn->meth = 0;
 	http_reset_txn(s);
 	s->txn->flags |= TX_NOT_FIRST | TX_WAIT_NEXT_RQ;
